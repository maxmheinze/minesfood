---
title: "Mine Basin Regressions"
author: "Lukas Vashold"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


## Description

This Markdown contains preliminary results for RDD regressions of mines and their effects on agricultural productivity. The structure of the document is as follows:

```{r prelims, include=FALSE}
library("dplyr")
library("readr")
library("fixest")
library("pdftools")
library("rdrobust")
sapply(list.files("../R", ".R$"), \(f) {source(paste0("../R/", f)); TRUE})

df_reg <- readRDS(p("processed/df_reg.RDS"))
```


## Main Models

### Full sample

This specification includes:

* all years from **2001 to 2023**
* all basin systems, regardless of area mined in the mine basin itself
* all up/downstream basins up to **10** basins "away"


```{r reg_main_1, warning=FALSE, message=FALSE}
# no covariates, linear distance
# mod1_full = feols((max_cropland_EVI) ~
#                     (distance) + downstream |
#                     year +  as.factor(mine_basin),
#                   data = df_reg,
#                   cluster = "HYBAS_ID")

mod2_full = feols(c(max_cropland_EVI_africover, max_cropland_EVI_ESA) ~
                    (distance) * downstream |
                    year +  as.factor(mine_basin),
                  data = df_reg,
                  cluster = "HYBAS_ID")

# mod3_full = feols((max_EVI) ~
#                     (distance) + downstream  |
#                     year +  as.factor(mine_basin),
#                   data = df_reg,
#                   cluster = "HYBAS_ID")

mod4_full = feols((max_EVI) ~
                    (distance) * downstream  |
                    year +  as.factor(mine_basin),
                  data = df_reg,
                  cluster = "HYBAS_ID")

# with covariates, linear distance
# mod5_full = feols((max_cropland_EVI) ~
#                     (distance) + downstream +
#                     elevation + slope + soilgrid_grouped +
#                     tmp_max + precipitation |
#                     year + as.factor(mine_basin),
#                   data = df_reg,
#                   cluster = "HYBAS_ID")

mod6_full = feols(c(max_cropland_EVI_africover, max_cropland_EVI_ESA) ~
                    (distance) * downstream +
                    elevation + slope + soilgrid_grouped +
                    tmp_max + precipitation |
                    year +  as.factor(mine_basin),
                  data = df_reg,
                  cluster = "HYBAS_ID")

# mod7_full = feols((max_EVI) ~
#                     (distance) + downstream +
#                     elevation + slope + soilgrid_grouped +
#                     tmp_max + precipitation |
#                     year +  as.factor(mine_basin),
#                   data = df_reg,
#                   cluster = "HYBAS_ID")

mod8_full = feols((max_EVI) ~
                    distance * downstream +
                    elevation + slope + soilgrid_grouped +
                    tmp_max + precipitation |
                    year +  as.factor(mine_basin),
                  data = df_reg,
                  cluster = "HYBAS_ID")

etable(mod2_full, mod6_full, mod4_full, mod8_full)

evi_cropland_africover_avg <- df_reg |>
  filter(!is.na(max_cropland_EVI_africover)) |>
  pull(max_cropland_EVI_africover) |> mean()
evi_cropland_ESA_avg <- df_reg |>
  filter(!is.na(max_cropland_EVI_ESA)) |>
  pull(max_cropland_EVI_ESA) |> mean()
evi_avg <- df_reg |>
  filter(!is.na(max_EVI)) |>
  pull(max_EVI) |> mean()
```

Compared to the sample mean, the presence of a mine upstream reduces the overall EVI by **`r round(coef(mod4_full)["downstream"] / evi_avg * 100, 2)`%** (`r round(coef(mod8_full)["downstream"] / evi_avg * 100, 2)`%) and the EVI for croplands (Africover) by **`r round(coef(mod2_full[[1]])["downstream"] / evi_cropland_africover_avg * 100,2)`%** (`r round(coef(mod6_full[[1]])["downstream"] / evi_cropland_africover_avg * 100,2)`%) and EVI for croplands (ESA) by **`r round(coef(mod2_full[[2]])["downstream"] / evi_cropland_ESA_avg * 100,2)`%** (`r round(coef(mod6_full[[2]])["downstream"] / evi_cropland_ESA_avg * 100,2)`%) on average without (with) controls.



### Sample with time/distance restrictions

This specification includes:

* all years from **2016 to 2023**
* all basin systems, regardless of area mined in the mine basin itself
* all up/downstream basins up to **5** basins "away"


```{r reg_main_2, warning=FALSE, message=FALSE}
df_reg_restr <- df_reg |> filter(order <= 5, year > 2015)

# no covariates, linear distance
# mod1_restr = feols((max_cropland_EVI) ~ (distance) + downstream |
#                      year +  as.factor(mine_basin),
#                    data = df_reg_restr,
#                    cluster = "HYBAS_ID")

mod2_restr = feols(c(max_cropland_EVI_africover, mean_cropland_EVI_ESA) ~ (distance) * downstream |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr,
                   cluster = "HYBAS_ID")

# mod3_restr = feols((max_EVI) ~ (distance) + downstream |
#                      year +  as.factor(mine_basin),
#                    data = df_reg_restr,
#                    cluster = "HYBAS_ID")

mod4_restr = feols((max_EVI) ~ (distance) * downstream |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr,
                   cluster = "HYBAS_ID")

# with covariates, linear distance
# mod5_restr = feols((max_cropland_EVI) ~
#                      distance + downstream +
#                      elevation + slope + soilgrid_grouped +
#                      tmp_max + precipitation |
#                      year + as.factor(mine_basin),
#                    data = df_reg_restr,
#                    cluster = "HYBAS_ID")

mod6_restr = feols(c(max_cropland_EVI_africover, mean_cropland_EVI_ESA) ~
                     distance * downstream +
                     elevation + slope + soilgrid_grouped +
                     tmp_max + precipitation |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr,
                   cluster = "HYBAS_ID")

# mod7_restr = feols((max_EVI) ~
#                      distance + downstream +
#                      elevation + slope + soilgrid_grouped +
#                      tmp_max + precipitation |
#                      year +  as.factor(mine_basin),
#                    data = df_reg_restr,
#                    cluster = "HYBAS_ID")

mod8_restr = feols((max_EVI) ~
                     distance * downstream +
                     elevation + slope + soilgrid_grouped +
                     tmp_max + precipitation |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr,
                   cluster = "HYBAS_ID")

etable(mod2_restr, mod6_restr, mod4_restr, mod8_restr)

evi_cropland_africover_avg <- df_reg_restr |>
  filter(!is.na(max_cropland_EVI_africover)) |>
  pull(max_cropland_EVI_africover) |> mean()
evi_cropland_ESA_avg <- df_reg_restr |>
  filter(!is.na(max_cropland_EVI_ESA)) |>
  pull(max_cropland_EVI_ESA) |> mean()
evi_avg <- df_reg_restr |>
  filter(!is.na(max_EVI)) |>
  pull(max_EVI) |> mean()
```

Compared to the sample mean, the presence of a mine upstream reduces the overall EVI by **`r round(coef(mod4_restr)["downstream"] / evi_avg * 100, 2)`%** (`r round(coef(mod8_restr)["downstream"] / evi_avg * 100, 2)`%) and the EVI for croplands (Africover) by **`r round(coef(mod2_restr[[1]])["downstream"] / evi_cropland_africover_avg * 100,2)`%** (`r round(coef(mod6_restr[[1]])["downstream"] / evi_cropland_africover_avg * 100,2)`%) and for croplands (ESA) by **`r round(coef(mod2_restr[[2]])["downstream"] / evi_cropland_ESA_avg * 100,2)`%** (`r round(coef(mod6_restr[[2]])["downstream"] / evi_cropland_ESA_avg * 100,2)`%) on average without (with) controls.



### Sample with mine area restrictions

This specification includes:

* all years from **2001 to 2023**
* all basin systems where mined area **>1km^2**
* all up/downstream basins up to **10** basins "away"


```{r reg_main_3, warning=FALSE, message=FALSE}
basins_large_mines <- df_reg |> filter(mine_area_km2 > 1) |> pull(mine_basin) |> unique()
df_reg_large_mines <- df_reg |> filter(mine_basin %in% basins_large_mines)

# no covariates, linear distance
# mod1_large = feols((max_cropland_EVI) ~ (distance) + downstream |
#                year +  as.factor(mine_basin),
#              data = df_reg_large_mines,
#              cluster = "HYBAS_ID")

mod2_large = feols(c(max_cropland_EVI_africover, mean_cropland_EVI_ESA) ~ (distance) * downstream |
               year +  as.factor(mine_basin),
             data = df_reg_large_mines,
             cluster = "HYBAS_ID")

# mod3_large = feols((max_EVI) ~ (distance) + downstream |
#                year +  as.factor(mine_basin),
#              data = df_reg_large_mines,
#              cluster = "HYBAS_ID")

mod4_large = feols((max_EVI) ~ (distance) * downstream |
               year +  as.factor(mine_basin),
             data = df_reg_large_mines,
             cluster = "HYBAS_ID")

# with covariates, linear distance
# mod5_large = feols((max_cropland_EVI) ~
#                distance + downstream +
#                elevation + slope + soilgrid_grouped +
#                tmp_max + precipitation |
#                year + as.factor(mine_basin),
#              data = df_reg_large_mines,
#              cluster = "HYBAS_ID")

mod6_large = feols(c(max_cropland_EVI_africover, mean_cropland_EVI_ESA) ~
               distance * downstream +
               elevation + slope + soilgrid_grouped +
               tmp_max + precipitation |
               year +  as.factor(mine_basin),
             data = df_reg_large_mines,
             cluster = "HYBAS_ID")

# mod7_large = feols((max_EVI) ~
#                distance + downstream +
#                elevation + slope + soilgrid_grouped +
#                tmp_max + precipitation |
#                year +  as.factor(mine_basin),
#              data = df_reg_large_mines,
#              cluster = "HYBAS_ID")

mod8_large = feols((max_EVI) ~
               distance * downstream +
               elevation + slope + soilgrid_grouped +
               tmp_max + precipitation |
               year +  as.factor(mine_basin),
             data = df_reg_large_mines,
             cluster = "HYBAS_ID")

etable(mod2_large, mod6_large, mod4_large, mod8_large)

evi_cropland_africover_avg <- df_reg_large_mines |>
  filter(!is.na(max_cropland_EVI_africover)) |>
  pull(max_cropland_EVI_africover) |> mean()
evi_cropland_ESA_avg <- df_reg_large_mines |>
  filter(!is.na(max_cropland_EVI_ESA)) |>
  pull(max_cropland_EVI_ESA) |> mean()
evi_avg <- df_reg_large_mines |>
  filter(!is.na(max_EVI)) |>
  pull(max_EVI) |> mean()
```

Compared to the sample mean, the presence of a mine upstream reduces the overall EVI by **`r round(coef(mod4_large)["downstream"] / evi_avg * 100, 2)`%** (`r round(coef(mod8_large)["downstream"] / evi_avg * 100, 2)`%) and the EVI for croplands (Africover) by **`r round(coef(mod2_large[[1]])["downstream"] / evi_cropland_africover_avg * 100,2)`%** (`r round(coef(mod6_large[[1]])["downstream"] / evi_cropland_africover_avg * 100,2)`%) and for croplands (Africover) by **`r round(coef(mod2_large[[2]])["downstream"] / evi_cropland_ESA_avg * 100,2)`%** (`r round(coef(mod6_large[[2]])["downstream"] / evi_cropland_ESA_avg * 100,2)`%) on average without (with) controls.


### Sample with time/distance and mine area restrictions

This specification includes:

* all years from **2016 to 2023**
* all basin systems where mined area **>1km^2**
* all up/downstream basins up to **5** basins "away"


```{r reg_main_4, warning=FALSE, message=FALSE}
df_reg_restr_large <- df_reg_large_mines |> filter(order <= 5, year > 2015)

# no covariates, linear distance
# mod1_restr_large = feols((max_cropland_EVI) ~ (distance) + downstream |
#                      year +  as.factor(mine_basin),
#                    data = df_reg_restr_large,
#                    cluster = "HYBAS_ID")

mod2_restr_large = feols(c(max_cropland_EVI_africover, max_cropland_EVI_ESA) ~ (distance) * downstream |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr_large,
                   cluster = "HYBAS_ID")

# mod3_restr_large = feols((max_EVI) ~ (distance) + downstream |
#                      year +  as.factor(mine_basin),
#                    data = df_reg_restr_large,
#                    cluster = "HYBAS_ID")

mod4_restr_large = feols((max_EVI) ~ (distance) * downstream |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr_large,
                   cluster = "HYBAS_ID")

# with covariates, linear distance
# mod5_restr_large = feols((max_cropland_EVI) ~
#                      distance + downstream +
#                      elevation + slope + soilgrid_grouped +
#                      tmp_max + precipitation |
#                      year + as.factor(mine_basin),
#                    data = df_reg_restr_large,
#                    cluster = "HYBAS_ID")

mod6_restr_large = feols(c(max_cropland_EVI_africover, max_cropland_EVI_ESA) ~
                     distance * downstream +
                     elevation + slope + soilgrid_grouped +
                     tmp_max + precipitation |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr_large,
                   cluster = "HYBAS_ID")

# mod7_restr_large = feols((max_EVI) ~
#                      distance + downstream +
#                      elevation + slope + soilgrid_grouped +
#                      tmp_max + precipitation |
#                      year +  as.factor(mine_basin),
#                    data = df_reg_restr_large,
#                    cluster = "HYBAS_ID")

mod8_restr_large = feols((max_EVI) ~
                     distance * downstream +
                     elevation + slope + soilgrid_grouped +
                     tmp_max + precipitation |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr_large,
                   cluster = "HYBAS_ID")

etable(mod2_restr_large, mod6_restr_large, mod4_restr_large, mod8_restr_large)

evi_cropland_africover_avg <- df_reg_restr_large |>
  filter(!is.na(max_cropland_EVI_africover)) |>
  pull(max_cropland_EVI_africover) |> mean()
evi_cropland_ESA_avg <- df_reg_restr_large |>
  filter(!is.na(max_cropland_EVI_ESA)) |>
  pull(max_cropland_EVI_ESA) |> mean()
evi_avg <- df_reg_restr_large |>
  filter(!is.na(max_EVI)) |>
  pull(max_EVI) |> mean()
```

Compared to the sample mean, the presence of a mine upstream reduces the overall EVI by **`r round(coef(mod4_restr_large)["downstream"] / evi_avg * 100, 2)`%** (`r round(coef(mod8_restr_large)["downstream"] / evi_avg * 100, 2)`%) and the EVI for croplands (Africover) by **`r round(coef(mod2_restr_large[[1]])["downstream"] / evi_cropland_africover_avg * 100,2)`%** (`r round(coef(mod6_restr_large[[1]])["downstream"] / evi_cropland_africover_avg * 100,2)`%) and for croplands (ESA) by **`r round(coef(mod2_restr_large[[1]])["downstream"] / evi_cropland_ESA_avg * 100,2)`%** (`r round(coef(mod6_restr_large[[1]])["downstream"] / evi_cropland_ESA_avg * 100,2)`%) on average without (with) controls.



## Robustness


## Heterogeneity


### Ordering of Basins

This specification includes:

* all years from **2016 to 2023**
* all basin systems where mined area **>1km^2**
* all up/downstream basins up to **5** basins "away"


```{r reg_order, warning=FALSE, message=FALSE}
basins_large_mines <- df_reg |> filter(mine_area_km2 > 1) |> pull(mine_basin) |> unique()
df_reg_restr_large <- df_reg |> filter(year > 2015, 
                                       mine_basin %in% basins_large_mines)

# no covariates, distance over order 
mod1_order = feols((max_cropland_EVI_africover) ~ downstream |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr_large |> filter(order <= 1),
                   cluster = "HYBAS_ID")

mod2_order = feols((max_cropland_EVI_africover) ~ downstream |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr_large |> filter(order <= 2),
                   cluster = "HYBAS_ID")

mod3_order = feols((max_cropland_EVI_africover) ~ downstream |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr_large |> filter(order <= 3),
                   cluster = "HYBAS_ID")

mod4_order = feols((max_cropland_EVI_africover) ~ downstream |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr_large |> filter(order <= 4),
                   cluster = "HYBAS_ID")

mod5_order = feols((max_cropland_EVI_africover) ~ downstream |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr_large |> filter(order <= 5),
                   cluster = "HYBAS_ID")

mod6_order = feols((max_cropland_EVI_africover) ~ downstream |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr_large |> filter(order <= 6),
                   cluster = "HYBAS_ID")

mod7_order = feols((max_cropland_EVI_africover) ~ downstream |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr_large |> filter(order <= 7),
                   cluster = "HYBAS_ID")

mod8_order = feols((max_cropland_EVI_africover) ~ downstream |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr_large |> filter(order <= 8),
                   cluster = "HYBAS_ID")

mod9_order = feols((max_cropland_EVI_africover) ~ downstream |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr_large |> filter(order <= 9),
                   cluster = "HYBAS_ID")

mod10_order = feols((max_cropland_EVI_africover) ~ downstream |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr_large |> filter(order <= 10),
                   cluster = "HYBAS_ID")


coefplot(list(mod1_order, mod2_order, mod3_order, mod4_order, mod5_order,
              mod6_order, mod7_order, mod8_order, mod9_order, mod10_order))

# etable(mod1_order, mod2_order, mod3_order, mod4_order, mod5_order)
```


### By biome 

```{r reg_heterogeneity, warning=FALSE, message=FALSE, include=FALSE}
# Heterogeneity by biome
mod_hetero = feols(c(max_EVI, max_cropland_EVI_africover, max_cropland_EVI_ESA) ~
                     (distance + I(distance^2)) * downstream  +
                     elevation + slope + soilgrid_grouped +
                     tmp_max + precipitation | 
                     year +  as.factor(mine_basin),
                   data = df_reg,
                   split = "biome_name",
                   cluster = "HYBAS_ID")
etable(mod_hetero)
```


# RD Plot with Sample Restrictions

```{r rdplot}

# rdrobust Spatial Discontinuity  -----------------------------------------

dup_01 <- df_reg_restr_large %>%
  mutate(distance = ifelse(downstream == 0, distance*-1, distance))

dup_02 <- dup_01 %>%
  filter(year == 2021)

rdplot(dup_01$max_EVI, dup_01$distance,
       x.lim = c(-25,25),
       y.lim = c(0.1400,0.9933),
       x.lab="Distance",
       y.lab="max_EVI", p = 3)

rdplot(dup_01$max_cropland_EVI_africover, dup_01$distance,
       x.lim = c(-25,25),
       y.lim = c(0.02,0.96),
       x.lab="Distance",
       y.lab="max_cropland_EVI_africover", p = 1)

rdplot(dup_01$max_cropland_EVI_ESA, dup_01$distance,
       x.lim = c(-25,25),
       y.lim = c(0.02,0.96),
       x.lab="Distance",
       y.lab="max_cropland_EVI_ESA", p = 2)


```

