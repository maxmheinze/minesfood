---
title: "Mine Basin Regressions"
author: "Lukas Vashold"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


## Description

This Markdown contains preliminary results for RDD regressions of mines and their effects on agricultural productivity. The structure of the document is as follows:

```{r prelims, include=FALSE}
library("dplyr")
library("readr")
library("fixest")
library("pdftools")
library("rdrobust")
sapply(list.files("../R", ".R$"), \(f) {source(paste0("../R/", f)); TRUE})

df_reg <- readRDS(p("processed/df_reg.RDS"))
```


## Main Models

### Full sample

This specification includes:

* all years from **2001 to 2023**
* all basin systems, regardless of area mined in the mine basin itself
* all up/downstream basins up to **10** basins "away"


```{r main_mod_1, warning=FALSE, message=FALSE}
# no covariates, linear distance
# mod1_full = feols((max_cropland_EVI) ~
#                     (distance) + downstream |
#                     year +  as.factor(mine_basin),
#                   data = df_reg,
#                   cluster = "HYBAS_ID")

mod2_full = feols(c(max_cropland_EVI_africover, max_cropland_EVI_ESA) ~
                    (distance) * downstream |
                    year +  as.factor(mine_basin),
                  data = df_reg,
                  cluster = "HYBAS_ID")

#mod2_full = feols(c(max_cropland_EVI_africover, max_cropland_EVI_ESA) ~
#                    ((distance) + I(distance^2)) * downstream |
#                    year +  as.factor(mine_basin),
#                  data = df_reg,
#                  cluster = "HYBAS_ID")

# mod3_full = feols((max_EVI) ~
#                     (distance) + downstream  |
#                     year +  as.factor(mine_basin),
#                   data = df_reg,
#                   cluster = "HYBAS_ID")

mod4_full = feols((max_EVI) ~
                    (distance) * downstream  |
                    year +  as.factor(mine_basin),
                  data = df_reg,
                  cluster = "HYBAS_ID")

# with covariates, linear distance
# mod5_full = feols((max_cropland_EVI) ~
#                     (distance) + downstream +
#                     elevation + slope + soilq_avg +
#                     tmp_max + precipitation |
#                     year + as.factor(mine_basin),
#                   data = df_reg,
#                   cluster = "HYBAS_ID")

mod6_full = feols(c(max_cropland_EVI_africover, max_cropland_EVI_ESA) ~
                    (distance) * downstream +
                    elevation + slope + soilq_avg +
                    tmp_max + precipitation |
                    year +  as.factor(mine_basin),
                  data = df_reg,
                  cluster = "HYBAS_ID")

# mod7_full = feols((max_EVI) ~
#                     (distance) + downstream +
#                     elevation + slope + soilq_avg +
#                     tmp_max + precipitation |
#                     year +  as.factor(mine_basin),
#                   data = df_reg,
#                   cluster = "HYBAS_ID")

mod8_full = feols((max_EVI) ~
                    distance * downstream +
                    elevation + slope + soilq_avg +
                    tmp_max + precipitation |
                    year +  as.factor(mine_basin),
                  data = df_reg,
                  cluster = "HYBAS_ID")

etable(mod2_full, mod6_full, mod4_full, mod8_full)

evi_cropland_avg <- df_reg |>
  filter(!is.na(max_cropland_EVI_africover)) |>
  pull(max_cropland_EVI_africover) |> mean()
evi_avg <- df_reg |>
  filter(!is.na(max_EVI)) |>
  pull(max_EVI) |> mean()
```

Compared to the sample mean, the presence of a mine upstream reduces the overall EVI by **`r round(coef(mod4_full)["downstream"] / evi_avg * 100, 2)`%** (`r round(coef(mod8_full)["downstream"] / evi_avg * 100, 2)`%) and the EVI for croplands by **`r round(coef(mod2_full)["downstream"] / evi_cropland_avg * 100,2)`%** (`r round(coef(mod6_full)["downstream"] / evi_cropland_avg * 100,2)`%) on average without (with) controls.



### Sample with time/distance restrictions

This specification includes:

* all years from **2016 to 2023**
* all basin systems, regardless of area mined in the mine basin itself
* all up/downstream basins up to **5** basins "away"


```{r main_mod_2, warning=FALSE, message=FALSE}
df_reg_restr <- df_reg |> filter(order <= 5, year > 2015)

# no covariates, linear distance
# mod1_restr = feols((max_cropland_EVI) ~ (distance) + downstream |
#                      year +  as.factor(mine_basin),
#                    data = df_reg_restr,
#                    cluster = "HYBAS_ID")

mod2_restr = feols(c(max_cropland_EVI_africover, mean_cropland_EVI_ESA) ~ (distance) * downstream |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr,
                   cluster = "HYBAS_ID")

# mod3_restr = feols((max_EVI) ~ (distance) + downstream |
#                      year +  as.factor(mine_basin),
#                    data = df_reg_restr,
#                    cluster = "HYBAS_ID")

mod4_restr = feols((max_EVI) ~ (distance) * downstream |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr,
                   cluster = "HYBAS_ID")

# with covariates, linear distance
# mod5_restr = feols((max_cropland_EVI) ~
#                      distance + downstream +
#                      elevation + slope + soilq_avg +
#                      tmp_max + precipitation |
#                      year + as.factor(mine_basin),
#                    data = df_reg_restr,
#                    cluster = "HYBAS_ID")

mod6_restr = feols(c(max_cropland_EVI_africover, mean_cropland_EVI_ESA) ~
                     distance * downstream +
                     elevation + slope + soilq_avg +
                     tmp_max + precipitation |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr,
                   cluster = "HYBAS_ID")

# mod7_restr = feols((max_EVI) ~
#                      distance + downstream +
#                      elevation + slope + soilq_avg +
#                      tmp_max + precipitation |
#                      year +  as.factor(mine_basin),
#                    data = df_reg_restr,
#                    cluster = "HYBAS_ID")

mod8_restr = feols((max_EVI) ~
                     distance * downstream +
                     elevation + slope + soilq_avg +
                     tmp_max + precipitation |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr,
                   cluster = "HYBAS_ID")

etable(mod2_restr, mod6_restr, mod4_restr, mod8_restr)

evi_cropland_avg <- df_reg_restr |>
  filter(!is.na(max_cropland_EVI_africover)) |>
  pull(max_cropland_EVI_africover) |> mean()
evi_avg <- df_reg_restr |>
  filter(!is.na(max_EVI)) |>
  pull(max_EVI) |> mean()
```

Compared to the sample mean, the presence of a mine upstream reduces the overall EVI by **`r round(coef(mod4_restr)["downstream"] / evi_avg * 100, 2)`%** (`r round(coef(mod8_restr)["downstream"] / evi_avg * 100, 2)`%) and the EVI for croplands by **`r round(coef(mod2_restr)["downstream"] / evi_cropland_avg * 100,2)`%** (`r round(coef(mod6_restr)["downstream"] / evi_cropland_avg * 100,2)`%) on average without (with) controls.



### Sample with mine area restrictions

This specification includes:

* all years from **2001 to 2023**
* all basin systems where mined area **>1km^2**
* all up/downstream basins up to **10** basins "away"


```{r main_mod_3, warning=FALSE, message=FALSE}
basins_large_mines <- df_reg |> filter(mine_area_km2 > 1) |> pull(mine_basin) |> unique()
df_reg_large_mines <- df_reg |> filter(mine_basin %in% basins_large_mines)

# no covariates, linear distance
# mod1_large = feols((max_cropland_EVI) ~ (distance) + downstream |
#                year +  as.factor(mine_basin),
#              data = df_reg_large_mines,
#              cluster = "HYBAS_ID")

mod2_large = feols(c(max_cropland_EVI_africover, mean_cropland_EVI_ESA) ~ (distance) * downstream |
               year +  as.factor(mine_basin),
             data = df_reg_large_mines,
             cluster = "HYBAS_ID")

# mod3_large = feols((max_EVI) ~ (distance) + downstream |
#                year +  as.factor(mine_basin),
#              data = df_reg_large_mines,
#              cluster = "HYBAS_ID")

mod4_large = feols((max_EVI) ~ (distance) * downstream |
               year +  as.factor(mine_basin),
             data = df_reg_large_mines,
             cluster = "HYBAS_ID")

# with covariates, linear distance
# mod5_large = feols((max_cropland_EVI) ~
#                distance + downstream +
#                elevation + slope + soilq_avg +
#                tmp_max + precipitation |
#                year + as.factor(mine_basin),
#              data = df_reg_large_mines,
#              cluster = "HYBAS_ID")

mod6_large = feols(c(max_cropland_EVI_africover, mean_cropland_EVI_ESA) ~
               distance * downstream +
               elevation + slope + soilq_avg +
               tmp_max + precipitation |
               year +  as.factor(mine_basin),
             data = df_reg_large_mines,
             cluster = "HYBAS_ID")

# mod7_large = feols((max_EVI) ~
#                distance + downstream +
#                elevation + slope + soilq_avg +
#                tmp_max + precipitation |
#                year +  as.factor(mine_basin),
#              data = df_reg_large_mines,
#              cluster = "HYBAS_ID")

mod8_large = feols((max_EVI) ~
               distance * downstream +
               elevation + slope + soilq_avg +
               tmp_max + precipitation |
               year +  as.factor(mine_basin),
             data = df_reg_large_mines,
             cluster = "HYBAS_ID")

etable(mod2_large, mod6_large, mod4_large, mod8_large)

evi_cropland_avg <- df_reg_large_mines |>
  filter(!is.na(max_cropland_EVI_africover)) |>
  pull(max_cropland_EVI_africover) |> mean()
evi_avg <- df_reg_large_mines |>
  filter(!is.na(max_EVI)) |>
  pull(max_EVI) |> mean()
```

Compared to the sample mean, the presence of a mine upstream reduces the overall EVI by **`r round(coef(mod4_large)["downstream"] / evi_avg * 100, 2)`%** (`r round(coef(mod8_large)["downstream"] / evi_avg * 100, 2)`%) and the EVI for croplands by **`r round(coef(mod2_large)["downstream"] / evi_cropland_avg * 100,2)`%** (`r round(coef(mod6_large)["downstream"] / evi_cropland_avg * 100,2)`%) on average without (with) controls.


### Sample with time/distance and mine area restrictions

This specification includes:

* all years from **2016 to 2023**
* all basin systems where mined area **>1km^2**
* all up/downstream basins up to **5** basins "away"


```{r main_mod_4, warning=FALSE, message=FALSE}
df_reg_restr_large <- df_reg_large_mines |> filter(order <= 5, year > 2015)

# no covariates, linear distance
# mod1_restr_large = feols((max_cropland_EVI) ~ (distance) + downstream |
#                      year +  as.factor(mine_basin),
#                    data = df_reg_restr_large,
#                    cluster = "HYBAS_ID")

mod2_restr_large = feols(c(max_cropland_EVI_africover, max_cropland_EVI_ESA) ~ (distance) * downstream |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr_large,
                   cluster = "HYBAS_ID")

# mod3_restr_large = feols((max_EVI) ~ (distance) + downstream |
#                      year +  as.factor(mine_basin),
#                    data = df_reg_restr_large,
#                    cluster = "HYBAS_ID")

mod4_restr_large = feols((max_EVI) ~ (distance) * downstream |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr_large,
                   cluster = "HYBAS_ID")

# with covariates, linear distance
# mod5_restr_large = feols((max_cropland_EVI) ~
#                      distance + downstream +
#                      elevation + slope + soilq_avg +
#                      tmp_max + precipitation |
#                      year + as.factor(mine_basin),
#                    data = df_reg_restr_large,
#                    cluster = "HYBAS_ID")

mod6_restr_large = feols(c(max_cropland_EVI_africover, max_cropland_EVI_ESA) ~
                     distance * downstream +
                     elevation + slope + soilq_avg +
                     tmp_max + precipitation |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr_large,
                   cluster = "HYBAS_ID")

# mod7_restr_large = feols((max_EVI) ~
#                      distance + downstream +
#                      elevation + slope + soilq_avg +
#                      tmp_max + precipitation |
#                      year +  as.factor(mine_basin),
#                    data = df_reg_restr_large,
#                    cluster = "HYBAS_ID")

mod8_restr_large = feols((max_EVI) ~
                     distance * downstream +
                     elevation + slope + soilq_avg +
                     tmp_max + precipitation |
                     year +  as.factor(mine_basin),
                   data = df_reg_restr_large,
                   cluster = "HYBAS_ID")

etable(mod2_restr_large, mod6_restr_large, mod4_restr_large, mod8_restr_large)

evi_cropland_avg <- df_reg_restr_large |>
  filter(!is.na(max_cropland_EVI_africover)) |>
  pull(max_cropland_EVI_africover) |> mean()
evi_avg <- df_reg_restr_large |>
  filter(!is.na(max_EVI)) |>
  pull(max_EVI) |> mean()
```

Compared to the sample mean, the presence of a mine upstream reduces the overall EVI by **`r round(coef(mod4_restr_large)["downstream"] / evi_avg * 100, 2)`%** (`r round(coef(mod8_restr_large)["downstream"] / evi_avg * 100, 2)`%) and the EVI for croplands by **`r round(coef(mod2_restr_large)["downstream"] / evi_cropland_avg * 100,2)`%** (`r round(coef(mod6_restr_large)["downstream"] / evi_cropland_avg * 100,2)`%) on average without (with) controls.



## Robustness


## Heterogeneity

```{r reg_heterogeneity, warning=FALSE, message=FALSE}
# Heterogeneity by biome
mod_hetero = feols(c(max_EVI, max_cropland_EVI_africover, max_cropland_EVI_ESA) ~
                     (distance + I(distance^2)) * downstream  +
                     elevation + slope + soilq_avg +
                     tmp_max + precipitation | 
                     year +  as.factor(mine_basin),
                   data = df_reg,
                   split = "biome_name",
                   cluster = "HYBAS_ID")
etable(mod_hetero)
```

# RD Plot with Sample Restrictions
```{r rdplot}
# outcome
basin_evi <- read_csv(p("basins_evi/basin_evi.csv"))

# treatment
dup <- read_csv(p("processed/downstream_upstream_distance_ordered.csv"))

# geographical controls
geo_controls <- readRDS(p("processed/geo_data_agg.RDS"))

# meteorological controls
met_controls <- readRDS(p("processed/met_data_agg.RDS"))

# Prepare Data for Regression ---------------------------------------------
df_reg <- full_join(dup, basin_evi, by = "HYBAS_ID") |>
  left_join(geo_controls, by = "HYBAS_ID") |>
  left_join(met_controls, by = c("HYBAS_ID", "year")) |>
  mutate(t.trend = year - 2000)

# what's done here is that we exclude basins where some of the time-invariant stuff
# is missing and that we assign a downstream basin to be unique for a mine? Meaning
# that a basin can only be downstream to one mine but not more? we only lose ~50
# observations with that, would have expected more given that mines are clustered

# Do we properly account for the possibility that a basin that is downstream to a
# mine should not be upstream to another?
df_reg <- df_reg %>%
  filter(!is.na(eco_id)) |>
  mutate(downstream = ifelse(distance == 0, 1, downstream),
         distance = distance) %>%
  group_by(HYBAS_ID, year) %>%
  arrange(distance) %>%
  slice_head(n = 1) %>%
  ungroup()

# rdrobust Spatial Discontinuity  -----------------------------------------

basins_large_mines <- df_reg |> filter(mine_area_km2 > 1) |> pull(mine_basin) |> unique()
df_reg_large_mines <- df_reg |> filter(mine_basin %in% basins_large_mines)


dup_01 <- df_reg_large_mines %>%
  mutate(distance = ifelse(downstream == 0, distance*-1, distance)) %>%
  mutate(distance = distance/10^3)

dup_02 <- dup_01 %>%
  filter(year == 2021)

rdplot(dup_02$max_EVI, dup_02$distance,
       #x.lim = c(-25,25),
       y.lim = c(0.1400,0.9933),
       x.lab="Distance",
       y.lab="max_EVI", p = 3)

rdplot(dup_01$max_cropland_EVI_africover, dup_01$distance,
       x.lim = c(-25,25),
       y.lim = c(0.02,0.96),
       x.lab="Distance",
       y.lab="max_cropland_EVI_africover", p = 1)

rdplot(dup_01$max_cropland_EVI_ESA, dup_01$distance,
       #x.lim = c(-25,25),
       y.lim = c(0.02,0.96),
       x.lab="Distance",
       y.lab="max_cropland_EVI_ESA", p = 2)


```

