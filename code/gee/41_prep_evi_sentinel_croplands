// SENTINEL LAND USE MASK: CROPLAND EVI, MEAN AND MAX PER BASIN
// GOOGLE EARTH ENGINE SCRIPT NO. 41
// OUTPUTS: S11 (MAX), S12 (MEAN)

// Load the basins dataset
var basins = ee.FeatureCollection("users/maxmheinze/relevant_basins");

// Define the date range for twenty years
var startDate = '2000-01-01';
var endDate = '2023-12-31';

// Load MODIS EVI image collection
var modisEVI = ee.ImageCollection("MODIS/061/MOD13Q1")
  .filterDate(startDate, endDate)
  .select(['EVI', 'SummaryQA']);

// Load land cover data 
var landCover = ee.ImageCollection('projects/sat-io/open-datasets/landcover/ESRI_Global-LULC_10m_TS')
  .select('b1');

// Function for Cloud Masking
var bitwiseExtract = function(input, fromBit, toBit) {
  var maskSize = ee.Number(1).add(toBit).subtract(fromBit);
  var mask = ee.Number(1).leftShift(maskSize).subtract(1);
  return input.rightShift(fromBit).bitwiseAnd(mask);
};

var maskSnowAndClouds = function(image) {
  var summaryQa = image.select('SummaryQA');
  var qaMask = bitwiseExtract(summaryQa, 0, 1).lte(1);
  var maskedImage = image.updateMask(qaMask);
  return maskedImage.copyProperties(
    image, ['system:index', 'system:time_start']);
};

// Precompute the 2017 land cover mosaic for use in earlier years
var landCover2017 = landCover.filterDate('2017-01-01', '2017-12-31').mosaic();

// Function for Land Use Masking
var maskLanduse = function(image) {
  var year = ee.Date(image.get('system:time_start')).get('year');
  var start = ee.Date.fromYMD(year, 1, 1);
  var end = start.advance(1, 'year');

  // Mosaic all tiles for the given year
  var filteredTiles = landCover.filterDate(start, end);
  var yearlyMosaic = filteredTiles.mosaic();
  var mosaicHasBands = yearlyMosaic.bandNames().size().gt(0);

  // If no valid mosaic exists, use the 2017 mosaic for earlier years
  var landCoverMask = ee.Algorithms.If(
    mosaicHasBands,
    yearlyMosaic.eq(5),
    landCover2017.eq(5) // Use 2017 mosaic as fallback
  );

  // Apply the land cover mask
  return image.updateMask(landCoverMask).copyProperties(
    image, ['system:index', 'system:time_start']
  );
};

// Function for Scaling Pixel Values
var eviScaled = function(image) {
  var scaled = image.divide(10000);
  return scaled.copyProperties(
    image, ['system:index', 'system:time_start']);
};

// Apply the functions to MODIS EVI
var processedModisEVI = modisEVI
  .map(maskSnowAndClouds)
  .map(maskLanduse)
  .map(eviScaled)
  .select('EVI');

// Function to calculate EVI for each basin
function calculateEVI(image, eviType) {
  return basins.map(function(feature) {
    // Extract the mean EVI for the basin
    var meanEVI = image.reduceRegion({
      reducer: ee.Reducer.mean(),
      geometry: feature.geometry(),
      scale: 250,
      bestEffort: true
    }).get('EVI');

    return feature.set({
      'image_date': image.date().format('YYYY-MM-dd'),
      'basin_id': feature.id(),
      'HYBAS_ID': feature.get('HYBAS_I'),
      'EVI': meanEVI,
      'landuse_type': 'cropland',
      'EVI_type': eviType
    });
  });
}

// Split the data into smaller chunks by year
var years = ee.List.sequence(2000, 2023);

// Mean per basin, for each 16-day period separately
var meanEVIResults = ee.FeatureCollection(years.map(function(year) {
  var yearlyModisEVI = processedModisEVI.filter(ee.Filter.calendarRange(year, year, 'year'));
  return yearlyModisEVI.map(function(image) {
    return calculateEVI(image, 'mean');
  }).flatten();
}).flatten());

// Maximum per pixel
var maxEVIResults = ee.FeatureCollection(years.map(function(year) {
  var yearStr = ee.Number(year).format("%.0f");
  var dateStr = ee.String(yearStr).cat('-06-30'); // Correct date format
  var dateDat = ee.Date(dateStr);
  var yearlyModisEVI = processedModisEVI.filter(ee.Filter.calendarRange(year, year, 'year'));
  var maxModisEVImax = yearlyModisEVI.max().set('system:time_start', dateDat.millis()); 
  return calculateEVI(maxModisEVImax, 'max');
}).flatten());

// Export the results to tables
Export.table.toDrive({
  collection: meanEVIResults.flatten(),
  description: 's12_evi_mean_croplands',
  folder: 'jde_basins', 
  fileFormat: 'CSV',
  selectors: ['basin_id', 'HYBAS_ID', 'EVI', 'image_date', 'landuse_type', 'EVI_type']
});

Export.table.toDrive({
  collection: maxEVIResults.flatten(),
  description: 's11_evi_max_croplands',
  folder: 'jde_basins', 
  fileFormat: 'CSV',
  selectors: ['basin_id', 'HYBAS_ID', 'EVI', 'image_date', 'landuse_type', 'EVI_type']
});
