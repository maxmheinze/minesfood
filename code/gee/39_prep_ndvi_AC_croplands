// Load the sample basins dataset
var basins = ee.FeatureCollection("users/lukasvashold/relevant_basins");

// Define the date range for 2000-2023
var startDate = '2000-01-01';
var endDate = '2023-12-31';

// Load cropland mask from Africover that is constant over years
var croplandMask = ee.ImageCollection("projects/sat-io/open-datasets/DEAF/CROPLAND-EXTENT/mask")
  .mosaic()
  .select('b1');  // Assuming 'cropland_extent' is the band name for cropland classification

// Load MODIS NDVI image collection
var modisNDVI = ee.ImageCollection("MODIS/061/MOD13Q1")
  .filterDate(startDate, endDate)
  .select(['NDVI', 'SummaryQA']);

// Function for Cloud Masking
var bitwiseExtract = function(input, fromBit, toBit) {
  var maskSize = ee.Number(1).add(toBit).subtract(fromBit);
  var mask = ee.Number(1).leftShift(maskSize).subtract(1);
  return input.rightShift(fromBit).bitwiseAnd(mask);
};

var maskSnowAndClouds = function(image) {
  var summaryQa = image.select('SummaryQA');
  var qaMask = bitwiseExtract(summaryQa, 0, 1).lte(1);
  var maskedImage = image.updateMask(qaMask);
  return maskedImage.copyProperties(
    image, ['system:index', 'system:time_start']);
};

// Function for Scaling Pixel Values
var ndviScaled = function(image) {
  var scaled = image.divide(10000);
  return scaled.copyProperties(
    image, ['system:index', 'system:time_start']);
};

// Apply the functions and select the 'NDVI' band
var scaledModisNDVI = modisNDVI
  .map(maskSnowAndClouds)
  .map(ndviScaled)
  .select('NDVI');

// Function to calculate mean NDVI for each image using the cropland mask
function calculateMeanNDVI(image) {
  var year = ee.Date(image.get('system:time_start')).get('year').format();
  // var croplandMask = ee.Image(vegetation.get(year));
  var maskedImage = image.updateMask(croplandMask);

  return maskedImage.reduceRegions({
    collection: basins,
    reducer: ee.Reducer.mean(),
    scale: 250
  }).map(function(feature) {
    return feature.set({
      'image_date': image.date().format('YYYY-MM-dd'),
      'basin_id': feature.id(),
      'HYBAS_ID': feature.get('HYBAS_I'), // apparently the shape file has not the full name
      'mean_NDVI': feature.get('mean')
    });
  });
}

// // Split the data into smaller chunks by year
var years = ee.List.sequence(2000, 2023);

// mean per basin, for each 16-day period separately
var meanNDVIResults = ee.FeatureCollection(years.map(function(year) {
  var yearStr = ee.Number(year).format();
  var yearlyModisNDVI = scaledModisNDVI.filter(ee.Filter.calendarRange(year, year, 'year'));
  return yearlyModisNDVI.map(calculateMeanNDVI).flatten();
}).flatten());

// maximum per pixel
var maxNDVIResults = ee.FeatureCollection(years.map(function(year) {
  var yearStr = ee.Number(year).format("%.0f");
  var dateStr = ee.String(yearStr).cat('-06-30');
  var dateDat = ee.Date(dateStr);
  var yearlyModisNDVI = scaledModisNDVI.filter(ee.Filter.calendarRange(year, year, 'year'));
  var maxModisNDVImax = yearlyModisNDVI.max().set('system:time_start', dateDat.millis()); 
  return calculateMeanNDVI(maxModisNDVImax);
}).flatten());

// Export the results to tables
Export.table.toDrive({
  collection: meanNDVIResults.flatten(),
  description: '09_ndvi-mean_africover',
  folder: 'jde_basins', 
  fileFormat: 'CSV',
  selectors: ['basin_id', 'HYBAS_ID', 'mean_NDVI', 'image_date']
});

Export.table.toDrive({
  collection: maxNDVIResults.flatten(),
  description: '19_ndvi-max_africover',
  folder: 'jde_basins', 
  fileFormat: 'CSV',
  selectors: ['basin_id', 'HYBAS_ID', 'mean_NDVI', 'image_date']
});