// Load the sample basins dataset
var basins = ee.FeatureCollection("users/gustav/relevant_basins");

// Define the date range for twenty years
var startDate = '2001-01-01';
var endDate = '2024-05-01';

// Load MODIS EVI image collection
var modisEVI = ee.ImageCollection("MODIS/061/MOD13Q1")
  .filterDate(startDate, endDate)
  .select(['EVI', 'DetailedQA']);

// Function to mask out low-quality pixels using DetailedQA band
function maskQuality(image) {
  var qa = image.select('DetailedQA');
// Extract the first two bits and check if they are 0 or 1
  var mask = qa.bitwiseAnd(3).eq(0).or(qa.bitwiseAnd(3).eq(1));
  return image.updateMask(mask).select('EVI').copyProperties(image, ['system:time_start']);
}

// Apply the quality mask to the MODIS EVI collection
var filteredModisEVI = modisEVI.map(maskQuality);

// Scale the EVI values by 0.0001
var scaledModisEVI = filteredModisEVI.map(function(image) {
  return image.multiply(0.0001).copyProperties(image, ['system:time_start']);
});

// Function to calculate mean EVI for each image
function calculateMeanEVI(image) {
  return image.reduceRegions({
    collection: basins,
    reducer: ee.Reducer.mean(),
    scale: 250
  }).map(function(feature) {
    return feature.set({
      'image_date': image.date().format('YYYY-MM-dd'),
      'basin_id': feature.id(),
      'HYBAS_ID': feature.get('HYBAS_ID'),  // Include HYBAS_ID
      'mean_EVI': feature.get('mean')
    });
  });
}

// Apply the mean EVI calculation to each image in the collection
var meanEVICollection = scaledModisEVI.map(calculateMeanEVI).flatten();

// Convert the results to a FeatureCollection
var meanEVIResults = ee.FeatureCollection(meanEVICollection);

// Export the results to a table
Export.table.toDrive({
  collection: meanEVIResults,
  description: 'mean_evi_basins',
  fileFormat: 'CSV',
  selectors: ['basin_id', 'HYBAS_ID', 'mean_EVI', 'image_date']  // Include HYBAS_ID in selectors
});

print(meanEVIResults);
